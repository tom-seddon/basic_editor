$START\ *** SEARCH ***.Badpgm JMP WARMSTART \Let BASIC say Bad program.'Search \SEARCH PRGM LINE FOR SS\Rtns Z=0 if TOP reached\C=0 If match found,(Ptr)Y=byte after match ends\C=1 If no matchLDY#0STY &8B \Reset quotes flag at line startLDA(Addr),YCMP#13BNE Badpgm \Line must start CRINYLDA(Addr),YBPL @E+4 \Not TOP, TOP=&FFTYARTS \TOP reached,Z=0LDY#3LDA(Addr),Y \Get Line LenSECSBC#4 \4bytes/line overheadsSBC SSLenW \Sub ST len less wilds at endsBCC Nomatch \Line len < ST len?LDY#0LDX SSLenCPX#1BEQ Se \If single chr search cant match len byteLDA&556 \First byte of SSCMP#3 \WC?BCS Se \NoINYDEXLDA#3 \If WC assume Linelen byte as a match, and start at byte 2 of SS,initial offset 3, 1 less byte to compareBNE WildB.Se LDA#4 \Normal offset.WildB STA Offset \Posn of Ptr wrt AddrCLCADC Addr \A=3 or 4STA PtrLDA Addr+1ADC#0STA PtrHi \Ptr now to first byte of line text if not ctrlBBNE Sb \Skip for first byte of line.'Sa LDY#0LDA(PtrLo),YCMP#&22BNE GWXLDA &8BEOR#&FFSTA&8B \Toggle quotes flag.GWX LDX SSLen \Search$ Len.Sb LDA(PtrLo),YCMP#13 \Prgm byte=CR?BNE Sf \NoCPX#1 \Last chr of S$BNE NomatchTYABEQ Nomatch \If Y=0 single chr search, cant allow match even if WCLDA &556,Y \Last chr of S$CMP#3 \WC?BCC Matching \If last chr of S$ is WC it can match the CRBCS Nomatch.Sf LDA &556,Y \Search$BEQ Wild \Assume match if SS byte is 0,(Wildcard)CMP#1 \Non numeric wild?BEQ NumWildCMP#2BEQ NonvariableCMP (PtrLo),Y \=Prgm byte?BNE Sc \No match.Wild INYDEXBNE Sb.Matching LDA#0CLCRTS \Match found,C=0,Z=1.NumWild \Non numeric wilds hereLDA(PtrLo),Y \Line byteCMP#&30BCC Wild \assume match if<"0"CMP#&3ABCS Wild \assume match if>"9".Sc.'ConSrchINC PtrLoBNE @E+4INC PtrHiINC Offset \Offset is posn of (Ptr) wrt to (Adr).Sd BNE Sa.Nomatch SECLDA#0RTS \No match this line,C=1,Z=1.Nonvariable LDA(PtrLo),YCMP#"&"BEQ Sc \Hex& not allowedJSR TypeBCS Sc \Letter, NO matchCPX#1BEQ LastCMP#&F2 \PROC?BEQ Sc \Include PROC/FN in name if not last chrCMP#&A4 \FN?BEQ ScBNE Wild\IF last chr of S$ (X=1), A number cant match ctrlB (ie can be part of name).Last CMP#&30BCC NV2 \<0CMP#&3A \>9?BCC Sc \0-9 cant match ctrlB, ie can be part of name.NV2 \Check last chr for %$(CMP#"%"BEQ Sc \take % as name chr\Prevents NAME^B matching NAME%CMP#"$"BEQ ScCMP#"(" \Array?BNE Wild\For ( check S$ for PROC/FNLDX SSLen.NV3 LDA &555,XCMP#&F2 \PROC?BEQ NV4CMP#&A4 \FN?BEQ NV4DEXBNE NV3LDX#1BNE Sc \No FN/PROC found, take ( as part of real name, prevent match.NV4 LDX#1BNE Wild \IF PROC/FN found allow ( to match CtrlB$END