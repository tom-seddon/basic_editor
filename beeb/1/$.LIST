$START\ ******** LIST **************\.'List_nohl LDA#&FFBMI List2 \No highlighting .'List \List all match linesLDA#0 \Highlights on.List2 STA HighlightJSR StartBEQ @E+5 .Nxtlist JSR NextlineBIT&FF \Test escapeBMI LL1JSR SearchBNE LL1 \TOP reachedBCS Nxtlist  \No matchTYACLCADC OffsetSTA Lineend \Partial listing pointerLDA OffsetSTA Match \Rqd for highlightingJSR Listline \List match line up to first match.NL2 JSR ConSrch \Keep looking on same linePHP \Save result of searchTYACLCADC OffsetLDY Lineend \Pickup where listing stoppedSTA Lineend \Partial listing pointerPLP \result of searchBCC NL3 \Another matchLDA#&FFSTA Lineend \Rest of lineSTA Match \No highlightJSR Contlist \List rest of line, match still OK as pastJMP Nxtlist.NL3 LDA OffsetSTA Match \Update match posnJSR ContlistJMP NL2.LL1 JMP Choice \\ ********************************\ \LISTLINE For NO Highlight, Match=FF. For Partial line list, Set Lineend to rqd length, else FF.'Listline JSR PrtLinoJSR Space1 \SpaceLDY#4 \First byte of textLDX#&FFSTX&4D \Quotes test flagLDA AddrSTA&BLDA Addr+1STA&C \Needed for LINBINY .'Contlist LDA MatchTAXCLCADC SSLenSTA Matchend \End of match$ posnCPX#4BCS ListbyteINC Match \Minimum Match is 4, 3=WC matching line len .Listbyte BIT HighlightBPL Lb2.Lb1 JMP Notyet \No highlighting.Lb2 CPY MatchBCC Lb1 \Wait for start of matchBNE MiddleTYAPHA \Save Y, Start of matchLDA#&86JSR OSBYTE \Read cursor pos .HL6 PLATAYPHALDA(Addr),Y \Next byteBMI HLtoken \TokenCPX Scrn_width \Last posn of line? 39/79BNE HL0 \NoBEQ HLnl \start highlight on new line .HLtoken TXASECSBC Scrn_width \ 39/79 ADC #8BCC HL0 .HLnl JSR OSNEWL \If within 8 of line end start new line for tokenBNE HL1 .HL0 TXABEQ HL1 \Start of newlineLDA #8JSR OSWRCH \Backspace 1LDA #&87JSR OSBYTE \Read chr at cursorCPX #&20 \Space?BEQ HL1 \Leave backspacedLDA #9JSR OSWRCH \Forward again.HL1 LDA Hlt_codeBNE HL4 \Start Highlight .Middle TYAPHA \Save YCPY MatchendBEQ HL3 \End of match$BCS HL5 \Past match$LDA#&86JSR OSBYTE \Get cursor xTXABEQ HL1 \Start of new line within match$PLATAYPHALDA(Addr),YBPL HL5 \Not tokenCPX#32BCS HLnl \New line if within 8 of end for tokenBCC HL5.HL3 LDA#&87 \End of match$, white defaultLDY Hlt_codeCPY#&88 \Flash?BNE @E+4LDA#&89JSR OSWRCHPLATAYLDA(Addr),YCMP#&20 \Next chr a space?BNE NotyetINYINC LineendBNE Notyet \Skip spaceDEC LineendBNE Notyet \If whole line listing, keep=FF.HL4 JSR OSWRCH.HL5 PLATAY .Notyet CPY LineendBCC LmoreCPY#&FFBEQ Lmore \Allow for max length linesRTS .Lmore LDA(Addr),YCMP#&D \CR?BEQ CRCMP#&22 \Quotes?BNE La \NoLDA#&FFEOR&4DSTA&4D \Toggle flagLDA#&22 .Lout JSR Printasci \|CtrlsINYJMP Listbyte .La BIT&4D \Within quotes?BPL Lout \YesCMP#&8D \Line#?BNE Lb \NoJSR LINBINY \Convert internal to binary number in IACTYAPHA \Save offsetJSR OUTIAC \PRINTline#PLATAYJMP Listbyte .Lb CMP#&80BCC LoutJSR DECRUNCH \TokenINYJMP Listbyte .CR JMP OSASCI \End of line$END