$START\ FORMLIS\ ***********************************.Indent=&75.Forcount=&76.Repcount=&77.Flag=&78\ **** FORMAT LISTING ****.exit JMP Choice.'Format LDA#0STA ForcountSTA RepcountJSR StartBJSR Start.Line LDY#1LDA(Addr),YORA&FFBMI exit \TOP or EscapedDEY \=0STY Indent \Reset indentsSTY&4D \Reset quotes flagSTY Flag \Set no tabs done yetJSR PrtLino \Printline#LDY#3.Nxtbyte INY.Byte LDA(Addr),YCMP#&D \CR?BNE Notcr.CR JSR OSASCIJSR NextlineJSR UpBBNE Line.Notcr CMP#&22 \Quote?BNE NotquoteLDA#&FFEOR&4D \Toggle flagSTA&4DLDA#&22.Lout JSR PrintbyteBNE Nxtbyte.Notquote BIT&4D \Quotes open?BMI Lout \YesCMP#&8D \Line# Mark?BNE NotlinoJSR LINBINY \Convert to binary in IACJSR OUTIAC \Print IAC in 0 fieldLDY&A \Pickup offsetBNE Byte.Notlino CMP#":"BNE NotcolonJSR Printbyte \Print the colonJSR Newline \Start newlineBNE Nxtbyte.Notcolon CMP#&E3 \FOR ?BNE NotforJSR Current \Newline + Current TabsINC Forcount.Notfor CMP#&F5 \REPEAT?BNE NotrepJSR Current \Newline + Current TabsINC Repcount.Notrep CMP#&E7 \IF ?BNE NotifJSR Current \Newline + Current TabsINC Indent.Notif CMP#&8C \THEN ?BNE NothenJSR Current \Newline + Current TabsBNE NL3.NL2 JSR Newline.NL3 BIT Flag \Tabs done?BMI @E+5 \YesJSR TabinCMP#&80BCC NTokJSR DECRUNCH \Print token or byteJMP Ckspc.NTok JSR PrintasciCMP#&40BCC Nxtbyte.Ckspc INYLDA(Addr),Y \Look at next byteBPL CK2 \Not a TokenJSR Space1 \Force a space between adjacent tokens.CK2 JMP Byte.Nothen CMP#&8B \ELSE ?BNE NotelseDEC IndentBPL NL2 \Start newline back 1INC Indent \If gone -ve force 0BPL NL2.Notelse CMP#&FD \UNTIL ?BNE NotuntilDEC RepcountBPL NL2 \Start newline back 1INC Repcount \If gone -ve force 0BPL NL2.Notuntil CMP#&ED \NEXT ?BNE NL3 \Not a formatting byteSTY&A \Save offset.NX1 DEC ForcountBPL NX2INC Forcount \If gone -ve force 0.NX2 INYLDA(Addr),Y \Look at next byteLDX#2.NX3 CMP NX5,X \Check against list of terminatorsBEQ NX4CMP#"," \Multiple Nexts ?BEQ NX1 \YesDEXBPL NX3BMI NX2 \Continue looking for terminator or ,.NX4 LDY&A \Pickup offsetLDA#&ED \NextBNE NL2 \Start newline with new indents.NX5 $EQUB ":" \List of bytes that can terminate NEXT string$EQUB 13 \CR$EQUB&8B \ELSE.Newline BIT FlagBPL D1 \Dont throw another newline if nothing done since the last onePHAJSR OSNEWLLDX#5 \Length of line no..NW1 JSR Space1DEXBNE NW1STX Flag \0= No tabs done yet AFTER CRPLA.D1 RTS.Current JSR Newline.Tabin CLCPHALDA IndentADC ForcountADC RepcountASL A \*2TAX.NW2 JSR Space1DEXBPL NW2 \Print X+1 spacesPLADEC Flag \-ve=tabs done this lineRTS.Printbyte BIT Flag \Tabs done?BMI @E+5 \YesJSR TabinJMP Printasci$END