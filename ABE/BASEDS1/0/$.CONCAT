$START\ CONCAT\***********************************.Concat_flag=&86.Vptr=&7F.'Startchr=&81.'Firstletter=&82.'Nameptr=&89.'Assmflag=&87.'Secondchr=&88\ ****  LINE CONCATENATE ROUTINE  ****.'CONCATENATEBIT Concat_flagBPL T1 \Not concatenatingJSR Start \Set (Addr) to PAGE.TRYITLDY#1LDA(Addr),YORA&FF \Test EscapeBPL T2.T1 SECLDA&A8SBC&12STA&2A \TOP differenceLDA&A9SBC&13STA&2BJSR En_Printer \Enable printerJSR Printmsg$EQUB 13$EQUS "Bytes saved= "$EQUB 0JSR OUTIACJSR Update_BasicJMP Choice.T2 LDY#3LDA(Addr),Y \Line lengthCLCADC AddrSTA Ptr \Set (Ptr) to next lineLDA Addr+1ADC#0STA Ptr+1LDY#1LDA(Ptr),YBMI T1 \TOP found, all doneLDY#3LDA(Addr),Y \Line length of line1SBC#2 \C=0, so -3CLCADC(Ptr),Y \Line length of line2BCC LenthOK \Total < 256, OK.FAILED \Cant add lines1+2 for any reasonLDA PtrSTA AddrLDA Ptr+1STA Addr+1 \Transfer line2 ptr to line1 ptrBNE TRYIT \and try with new line1.LenthOK \Check line2 is not referenced by numberLDY#1LDA(Ptr),Y \Line# HiSTA&2DINYLDA(Ptr),Y \Line# LoSTA&2CJSR Findcall \Search prgm for any reference to line# in 2C/2DBEQ FAILED \Line is referenced\Check lines for invalidating syntaxLDY#4 \Text start 4 bytes inLDA(Addr),YCMP#"*"BEQ FAILED \If line1 starts * then OS cmnd.LDA(Ptr),YCMP#&DDBEQ FAILED \Line2 cant start DEFCMP#&DCBEQ FAILED \Line2 cant start DATA.Check LDA(Addr),YINYCMP#13 \CR?BEQ Passed \End of line, syntax OKCMP#&E7 \IF?BEQ FAILEDCMP#&F4 \REM?BEQ FAILEDCMP#&DC \DATA?BEQ FAILEDCMP#&85 \ERROR?BEQ FAILEDCMP#":"BNE CheckLDA(Addr),Y \Next byteCMP#"*"BEQ FAILED \ colon* means OS cmnd.BNE Check.Passed \Syntax OK\COPY LINE 1 OUT TO BUFFERLDY#3.P1 INYLDA(Addr),YSTA &6FC,Y \Assemble line in page 7CMP#13 \CR?BNE P1LDA#":"STA &6FC,Y \Replace CR with colonTYATAXINX\ADD LINE 2 TO BUFFERLDY#3.P3 INYLDA(Ptr),YCMP#":" \Skip leading colonsBEQ P3.P2 LDA(Ptr),Y \Line2 textSTA &6FC,XINYINXCMP#13 \CR?BNE P2\PUT LINE1 Number in IAC, Save line2 number in tempJSR LinetoIAC \Put line# in 2A/BLDA(Ptr),YSTA&2CDEYLDA(Ptr),YSTA&2D \Save Line#2 in 2C/DLDY#0JSR INSERT \Insert compound line into prgm, text at 700,Y, number in IACJSR Iachi_lo \Transfer line#2 from 2C/D to 2A/BLDA#13 \CRSTA &700 \Put CR in line buffer, ie blank lineLDY#0JSR INSERT \Delete original line2, number in IACJSR Topover \Print TOPJMP T2$END