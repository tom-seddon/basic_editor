$START\ RELINK\ ****************************************.'BADPROG\RELINK BADPROGRAMLDA#&FFSTA HighlightSTA Lineend \List optionsJSR Start \(Addr)=PAGELDY#1STA(Addr),Y \A=0, OLD.Newtop LDY#0STY&2CSTY&2D \Reset last line#LDA#13STA(Addr),Y \CR at PAGEINY \=1LDA(Addr),YAND#&7F \Do OLDSTA(Addr),Y.Next JSR LinetoIAC \Put line# in 2A/B, Y=2LDX&2BCPX&2DBCC Badlen2 \New# < Old#BNE NX1 \New > Old okCMP&2C \If hibytes=, check lowsBCC Badlen2 \New<Old.NX1 STA&2CSTX&2D \Update old#INY \=3.Findcr INYBEQ Toolong \Max line len is 255LDA(Addr),YCMP#13 \CR?BEQ FoundcrCMP#32 \Control code?BCS Findcr \NoLDA#"#" \Mark controls with #STA(Addr),YBNE Findcr.Foundcr \Found CR terminating lineTYA \Y=Line lenLDY#3STA (Addr),Y \Set line len byteJSR Listline \List line# linkedJSR Nextline \Update (addr)LDX Addr+1INXCPX RAMTOP \Check addrBCS Toofar \Addr within 256 of Video ram?LDY#1LDA(Addr),Y \Next lines hi line#BPL Next \Link next lineBMI Repeat \Possible TOP found.Toolong \Y=256, no CR found within 255 bytes of line startLDY#3LDA(Addr),Y \Original line lenCMP#5BCC Badlen \Min length is 5TAYLDA#13STA(Addr),Y \Put CR according to original lengthBNE Foundcr.Toofar \(Addr) now in video?LDY#1LDA#&FFSTA(Addr),Y \Put a TOP in.Linkdone JSR Update_BasicJMP Choice \and finish.Badlen \No CR and length<5LDY#&FFLDA#13STA(Addr),Y \Put CR in at max lenTYA \=&FFLDY#&3STA(Addr),Y \Line LenBNE Badlen3.Badlen2 LDA#0LDY#2STA(Addr),Y \LSB of#DEYSTA(Addr),Y \MSB.Badlen3 LDY#1LDA(Addr),YORA#&80STA(Addr),Y \Force a TOP marker.Repeat \Ask if any more requiredLDA AddrCLCADC#2STA&12 \Update BASIC TOPLDA Addr+1ADC#0STA&13JSR OSNEWLJSR TopisJSR Printmsg$EQUS ", More?"$EQUB 0JSR YesNo \ROM's, always flushBNE Linkdone \NoJMP Newtop$END